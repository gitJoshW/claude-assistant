<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Claude Assistant ‚Äî Phase 3</title>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Instrument+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #faf8f4; --surface: #ffffff; --surface2: #f5f2ec;
      --border: #e8e2d8; --border2: #d4ccbc;
      --accent: #2d5016; --accent2: #4a7c28; --accent-light: #eef5e6;
      --text: #1a1a14; --text-dim: #5a5a48; --text-muted: #9a9a84;
      --high: #c0392b; --med: #d4870a; --low: #2471a3;
      --high-bg: #fdf0ee; --med-bg: #fef9ee; --low-bg: #eef4fd;
      --radius: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: 'Instrument Sans', sans-serif; min-height: 100vh; }

    /* TOPBAR */
    .topbar { background: var(--accent); color: white; padding: 0 2rem; height: 52px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .topbar-left { display: flex; align-items: baseline; gap: 0.75rem; }
    .topbar h1 { font-family: 'Instrument Serif', serif; font-size: 1.2rem; font-weight: 400; }
    .topbar-badge { font-size: 0.62rem; letter-spacing: 0.12em; text-transform: uppercase; background: rgba(255,255,255,0.15); padding: 0.2rem 0.5rem; border-radius: 20px; }
    .topbar-right { display: flex; align-items: center; gap: 1rem; }
    .sync-status { font-size: 0.7rem; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 0.4rem; }
    .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: rgba(255,255,255,0.3); transition: background 0.3s; }
    .sync-dot.ok { background: #7ed856; }
    .sync-dot.error { background: #ff6b6b; }
    .sync-dot.syncing { background: #ffd060; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

    /* LAYOUT */
    .main { display: grid; grid-template-columns: 240px 1fr 300px; min-height: calc(100vh - 52px); }
    @media (max-width: 900px) {
      .main { grid-template-columns: 1fr; }
      .sidebar-left, .sidebar-right { display: none; }
      .center { padding: 1rem; padding-bottom: 80px; }
    }

    /* ‚îÄ‚îÄ MOBILE BOTTOM NAV ‚îÄ‚îÄ */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 56px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      z-index: 200;
      align-items: center;
      justify-content: space-around;
      padding: 0 0.5rem;
    }
    @media (max-width: 900px) { .mobile-nav { display: flex; } }

    .mobile-nav-btn {
      display: flex; flex-direction: column; align-items: center;
      gap: 0.2rem; background: transparent; border: none; box-shadow: none;
      color: var(--text-muted); cursor: pointer; font-size: 0.6rem;
      font-family: 'Instrument Sans', sans-serif; font-weight: 500;
      letter-spacing: 0.04em; padding: 0.4rem 0.75rem; border-radius: 8px;
      transition: color 0.15s, background 0.15s;
    }
    .mobile-nav-btn svg { width: 20px; height: 20px; }
    .mobile-nav-btn:hover, .mobile-nav-btn.active { color: var(--accent); background: var(--accent-light); transform: none; }

    /* ‚îÄ‚îÄ MOBILE DRAWER ‚îÄ‚îÄ */
    .mobile-drawer-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(26,26,20,0.4);
      z-index: 300;
      backdrop-filter: blur(2px);
    }
    .mobile-drawer-overlay.open { display: block; }

    .mobile-drawer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-radius: 16px 16px 0 0;
      border-top: 1px solid var(--border);
      z-index: 400;
      padding: 1.25rem 1.25rem 2rem;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 85vh;
      overflow-y: auto;
    }
    .mobile-drawer.open { transform: translateY(0); }

    .drawer-handle {
      width: 36px; height: 4px; border-radius: 2px;
      background: var(--border2); margin: 0 auto 1.25rem;
    }
    .drawer-title {
      font-size: 0.72rem; font-weight: 500; color: var(--text-dim);
      letter-spacing: 0.04em; margin-bottom: 1rem;
    }
    .sidebar-left, .sidebar-right { border-right: 1px solid var(--border); padding: 1.5rem 1.25rem; }
    .sidebar-right { border-right: none; border-left: 1px solid var(--border); }
    .section-label { font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.85rem; font-weight: 500; }

    /* FILTERS */
    .stat-row { display: flex; flex-direction: column; gap: 0.3rem; margin-bottom: 1.5rem; }
    .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 0.45rem 0.7rem; border-radius: 6px; font-size: 0.76rem; cursor: pointer; transition: background 0.15s; }
    .stat-item:hover { background: var(--surface2); }
    .stat-item.active { background: var(--accent-light); color: var(--accent); }
    .stat-item .count { font-weight: 500; font-size: 0.8rem; }
    .cat-list { display: flex; flex-direction: column; gap: 0.25rem; }
    .cat-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem 0.7rem; border-radius: 6px; font-size: 0.73rem; cursor: pointer; transition: background 0.15s; color: var(--text-dim); }
    .cat-item:hover { background: var(--surface2); }
    .cat-item.active { background: var(--accent-light); color: var(--accent); }
    .cat-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--text-muted); flex-shrink: 0; }

    /* CENTER */
    .center { padding: 1.75rem 2rem; max-width: 680px; }
    .tab-nav { display: flex; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); }
    .tab-btn { background: transparent; border: none; border-bottom: 2px solid transparent; border-radius: 0; color: var(--text-muted); cursor: pointer; font-family: 'Instrument Sans', sans-serif; font-size: 0.78rem; font-weight: 500; margin-bottom: -2px; padding: 0.6rem 1rem; box-shadow: none; transition: color 0.15s, border-color 0.15s; }
    .tab-btn:hover { color: var(--text-dim); background: transparent; transform: none; }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* INPUT CARD */
    .input-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.25rem; margin-bottom: 1.5rem; }
    .input-card-title { font-family: 'Instrument Serif', serif; font-size: 1rem; font-style: italic; color: var(--text-dim); margin-bottom: 0.85rem; }
    textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Instrument Sans', sans-serif; font-size: 0.82rem; line-height: 1.65; padding: 0.75rem 0.9rem; resize: vertical; min-height: 80px; outline: none; transition: border-color 0.2s; }
    textarea:focus { border-color: var(--accent2); background: var(--surface); }
    textarea::placeholder { color: var(--text-muted); }
    .date-input-row { display: flex; align-items: center; gap: 0.6rem; margin-top: 0.6rem; font-size: 0.75rem; color: var(--text-muted); }
    .date-input-row input[type="date"] { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Instrument Sans', sans-serif; font-size: 0.75rem; padding: 0.35rem 0.65rem; outline: none; min-height: unset; transition: border-color 0.2s; cursor: pointer; }
    .btn-row { display: flex; gap: 0.5rem; margin-top: 0.75rem; align-items: center; }
    .hint { font-size: 0.68rem; color: var(--text-muted); margin-left: auto; }

    button { background: var(--accent); border: none; border-radius: 6px; color: white; cursor: pointer; font-family: 'Instrument Sans', sans-serif; font-size: 0.75rem; font-weight: 500; letter-spacing: 0.04em; padding: 0.55rem 1rem; transition: background 0.15s, transform 0.1s; box-shadow: 0 1px 2px rgba(0,0,0,0.12); }
    button:hover { background: var(--accent2); }
    button:active { transform: scale(0.97); }
    button:disabled { background: var(--border2); color: var(--text-muted); cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-outline { background: transparent; border: 1px solid var(--border2); color: var(--text-dim); box-shadow: none; }
    .btn-outline:hover { background: var(--surface2); border-color: var(--text-muted); }

    /* TASKS */
    .task-group-label { font-size: 0.62rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); margin: 1.25rem 0 0.6rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; }
    .task-group-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }
    .task-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.85rem 1rem; display: flex; align-items: flex-start; gap: 0.85rem; margin-bottom: 0.5rem; box-shadow: var(--shadow); transition: border-color 0.2s, box-shadow 0.2s, opacity 0.2s; animation: fadeUp 0.22s ease; position: relative; }
    .task-card:hover { border-color: var(--border2); box-shadow: var(--shadow-md); }
    .task-card.done { opacity: 0.45; box-shadow: none; }
    .task-card.priority-high { border-left: 3px solid var(--high); }
    .task-card.priority-medium { border-left: 3px solid var(--med); }
    .task-card.priority-low { border-left: 3px solid var(--low); }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .task-check { width: 17px; height: 17px; border: 1.5px solid var(--border2); border-radius: 4px; cursor: pointer; flex-shrink: 0; margin-top: 1px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .task-check:hover { border-color: var(--accent2); background: var(--accent-light); }
    .task-card.done .task-check { background: var(--accent); border-color: var(--accent); }
    .task-check svg { display: none; }
    .task-card.done .task-check svg { display: block; }
    .task-body { flex: 1; min-width: 0; }
    .task-title { font-size: 0.84rem; color: var(--text); line-height: 1.45; }
    .task-card.done .task-title { text-decoration: line-through; color: var(--text-muted); }
    .task-meta { display: flex; gap: 0.4rem; margin-top: 0.35rem; flex-wrap: wrap; align-items: center; }
    .badge { font-size: 0.62rem; letter-spacing: 0.06em; padding: 0.15rem 0.45rem; border-radius: 20px; font-weight: 500; }
    .badge-high { background: var(--high-bg); color: var(--high); }
    .badge-medium { background: var(--med-bg); color: var(--med); }
    .badge-low { background: var(--low-bg); color: var(--low); }
    .badge-cat { background: var(--accent-light); color: var(--accent); }
    .task-reason { font-size: 0.68rem; color: var(--text-muted); font-style: italic; margin-top: 0.3rem; line-height: 1.5; }
    .task-actions { display: flex; gap: 0.25rem; flex-shrink: 0; opacity: 0; transition: opacity 0.15s; }
    .task-card:hover .task-actions { opacity: 1; }
    .task-action-btn { background: transparent; border: 1px solid var(--border); border-radius: 5px; color: var(--text-muted); cursor: pointer; font-size: 0.68rem; padding: 0.2rem 0.45rem; box-shadow: none; transition: all 0.15s; }
    .task-action-btn:hover { background: var(--surface2); }
    .task-action-btn.del:hover { background: var(--high-bg); border-color: var(--high); color: var(--high); }

    /* DUE DATE */
    .due-date { display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.68rem; padding: 0.15rem 0.5rem; border-radius: 20px; font-weight: 500; background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border); cursor: pointer; transition: all 0.15s; }
    .due-date.overdue { background: var(--high-bg); color: var(--high); border-color: rgba(192,57,43,0.25); }
    .due-date.due-soon { background: var(--med-bg); color: var(--med); border-color: rgba(212,135,10,0.25); }
    .due-date.on-track { background: var(--accent-light); color: var(--accent2); border-color: rgba(74,124,40,0.25); }

    /* GOALS */
    .goal-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.1rem 1.2rem; margin-bottom: 0.75rem; box-shadow: var(--shadow); transition: border-color 0.2s; animation: fadeUp 0.22s ease; }
    .goal-card:hover { border-color: var(--border2); box-shadow: var(--shadow-md); }
    .goal-card.goal-achieved { opacity: 0.5; }
    .goal-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.6rem; }
    .goal-title { font-family: 'Instrument Serif', serif; font-size: 1rem; font-style: italic; color: var(--text); line-height: 1.3; flex: 1; }
    .goal-actions { display: flex; gap: 0.3rem; flex-shrink: 0; opacity: 0; transition: opacity 0.15s; }
    .goal-card:hover .goal-actions { opacity: 1; }
    .goal-desc { font-size: 0.78rem; color: var(--text-dim); line-height: 1.6; margin-bottom: 0.75rem; }
    .goal-progress-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.6rem; }
    .goal-progress-bar { flex: 1; height: 5px; background: var(--surface2); border-radius: 99px; overflow: hidden; border: 1px solid var(--border); }
    .goal-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent2), #7bc142); border-radius: 99px; transition: width 0.4s ease; }
    .goal-progress-pct { font-size: 0.7rem; font-weight: 500; color: var(--accent2); min-width: 2.5rem; text-align: right; }
    .goal-meta { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; margin-bottom: 0.6rem; }
    .goal-amount { font-size: 0.72rem; color: var(--text-muted); }
    .goal-amount strong { color: var(--text-dim); }
    .goal-note { font-size: 0.73rem; color: var(--text-muted); font-style: italic; border-top: 1px solid var(--border); padding-top: 0.55rem; margin-top: 0.25rem; cursor: pointer; transition: color 0.15s; }
    .goal-note:hover { color: var(--text-dim); }
    .goal-note-input { width: 100%; font-size: 0.73rem; font-style: italic; border-top: 1px solid var(--accent2); padding-top: 0.55rem; margin-top: 0.25rem; min-height: 48px; }
    .goal-form { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.25rem; margin-bottom: 1.5rem; }
    .goal-form-title { font-family: 'Instrument Serif', serif; font-size: 1rem; font-style: italic; color: var(--text-dim); margin-bottom: 0.85rem; }
    .goal-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; margin-bottom: 0.6rem; }
    .goal-form input[type="text"], .goal-form input[type="number"] { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Instrument Sans', sans-serif; font-size: 0.82rem; padding: 0.6rem 0.85rem; outline: none; width: 100%; transition: border-color 0.2s; min-height: unset; }
    .goal-form input:focus { border-color: var(--accent2); }
    .goal-form input::placeholder { color: var(--text-muted); }

    /* RIGHT SIDEBAR */
    .panel-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 1rem; }
    .panel-box-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .panel-box-title { font-size: 0.72rem; font-weight: 500; color: var(--text-dim); letter-spacing: 0.04em; }
    .panel-box-body { padding: 1rem; }

    /* NOTIFICATION LOG */
    .notif-item { padding: 0.6rem 0; border-bottom: 1px solid var(--border); font-size: 0.72rem; color: var(--text-dim); line-height: 1.4; }
    .notif-item:last-child { border-bottom: none; }
    .notif-item .notif-time { font-size: 0.65rem; color: var(--text-muted); margin-top: 0.15rem; }
    .notif-empty { font-size: 0.74rem; color: var(--text-muted); font-style: italic; }

    /* PHASE NOTE */
    .phase-note { background: var(--accent-light); border: 1px solid rgba(74,124,40,0.2); border-radius: 6px; padding: 0.7rem 0.9rem; font-size: 0.72rem; color: var(--accent); line-height: 1.6; margin-top: 0.75rem; }
    .phase-note strong { font-weight: 600; }

    /* SETUP MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(26,26,20,0.6); backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow-md); padding: 2rem; max-width: 480px; width: 100%; }
    .modal h2 { font-family: 'Instrument Serif', serif; font-size: 1.4rem; margin-bottom: 0.5rem; }
    .modal p { font-size: 0.8rem; color: var(--text-dim); line-height: 1.65; margin-bottom: 1rem; }
    .modal p a { color: var(--accent2); }
    .modal label { font-size: 0.72rem; font-weight: 500; color: var(--text-dim); display: block; margin-bottom: 0.3rem; margin-top: 0.75rem; }
    .modal input { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Instrument Sans', sans-serif; font-size: 0.82rem; padding: 0.7rem 0.9rem; outline: none; margin-bottom: 0.25rem; transition: border-color 0.2s; min-height: unset; }
    .modal input:focus { border-color: var(--accent2); }
    .modal-error { font-size: 0.72rem; color: var(--high); margin-bottom: 0.75rem; }

    /* EMPTY */
    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); font-size: 0.8rem; line-height: 1.8; }
    .empty-state .big { font-family: 'Instrument Serif', serif; font-size: 2rem; font-style: italic; color: var(--border2); display: block; margin-bottom: 0.5rem; }
  </style>
</head>
<body>

<!-- SETUP MODAL -->
<div class="modal-overlay" id="setup-modal">
  <div class="modal">
    <h2>Connect to your server</h2>
    <p>
      Phase 3 runs on your own backend server. Enter the URL of your deployed server
      and the secret you set in your <code>.env</code> file.
    </p>
    <label>Server URL</label>
    <input type="text" id="server-url-input" placeholder="https://my-assistant.onrender.com" />
    <label>API Secret</label>
    <input type="password" id="server-secret-input" placeholder="your-random-secret-here" />
    <div class="modal-error" id="modal-error" style="display:none"></div>
    <br/>
    <button onclick="connectServer()" style="width:100%;margin-top:0.5rem">Connect & Sync</button>
    <div class="phase-note" style="margin-top:1rem">
      <strong>Phase 3 concept:</strong> Claude now lives on a server, not just your browser.
      Tasks sync to the server so the scheduler can access them 24/7 and send proactive notifications.
    </div>
  </div>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-left">
    <h1>My Assistant</h1>
    <span class="topbar-badge">Phase 3 ¬∑ Proactive AI</span>
  </div>
  <div class="topbar-right">
    <div class="sync-status">
      <div class="sync-dot" id="sync-dot"></div>
      <span id="sync-label">Not connected</span>
    </div>
    <button class="btn-outline" style="font-size:0.68rem;padding:0.3rem 0.7rem;color:white;border-color:rgba(255,255,255,0.3)" onclick="syncNow()">Sync</button>
  </div>
</div>

<div class="main">

  <!-- LEFT SIDEBAR -->
  <div class="sidebar-left">
    <div class="section-label">Filter</div>
    <div class="stat-row">
      <div class="stat-item active" onclick="setFilter('all')" id="filter-all"><span>All tasks</span><span class="count" id="count-all">0</span></div>
      <div class="stat-item" onclick="setFilter('open')" id="filter-open"><span>Open</span><span class="count" id="count-open">0</span></div>
      <div class="stat-item" onclick="setFilter('done')" id="filter-done"><span>Done</span><span class="count" id="count-done">0</span></div>
      <div class="stat-item" onclick="setFilter('due-soon')" id="filter-due-soon"><span>‚è∞ Due soon</span><span class="count" id="count-due-soon">0</span></div>
    </div>
    <div class="section-label">Priority</div>
    <div class="stat-row">
      <div class="stat-item" onclick="setFilter('high')" id="filter-high"><span>üî¥ High</span><span class="count" id="count-high">0</span></div>
      <div class="stat-item" onclick="setFilter('medium')" id="filter-medium"><span>üü° Medium</span><span class="count" id="count-medium">0</span></div>
      <div class="stat-item" onclick="setFilter('low')" id="filter-low"><span>üîµ Low</span><span class="count" id="count-low">0</span></div>
    </div>
    <div class="section-label">Categories</div>
    <div class="cat-list" id="cat-list"></div>
    <br/>
    <button class="btn-outline" style="width:100%;font-size:0.7rem" onclick="clearDone()">Clear completed</button>
    <br/><br/>
    <button class="btn-outline" style="width:100%;font-size:0.7rem;color:var(--high);border-color:var(--high)" onclick="resetAll()">Reset everything</button>
  </div>

  <!-- CENTER -->
  <div class="center">
    <div class="tab-nav">
      <button class="tab-btn active" id="tab-tasks" onclick="switchTab('tasks')">Tasks</button>
      <button class="tab-btn" id="tab-goals" onclick="switchTab('goals')">Goals</button>
    </div>

    <!-- TASKS VIEW -->
    <div id="view-tasks">
      <div class="input-card">
        <div class="input-card-title">What needs to get done?</div>
        <textarea id="task-input" placeholder="Type tasks naturally ‚Äî 'call dentist, finish Q2 report by Friday, buy groceries'"></textarea>
        <div class="date-input-row">
          <span>Due date (optional)</span>
          <input type="date" id="due-date-input" />
          <span style="font-size:0.68rem;color:var(--text-muted)">applies to all tasks above</span>
        </div>
        <div class="btn-row">
          <button onclick="addTasks()" id="add-btn">Organize with Claude</button>
          <button class="btn-outline" onclick="addManual()">Add as-is</button>
          <span class="hint">‚åò‚Üµ to submit</span>
        </div>
      </div>
      <div id="task-container"></div>
    </div>

    <!-- GOALS VIEW -->
    <div id="view-goals" style="display:none">
      <div class="goal-form">
        <div class="goal-form-title">Add a long-term goal</div>
        <input type="text" id="goal-title-input" placeholder="Goal title ‚Äî e.g. Redo the backyard" style="margin-bottom:0.6rem;width:100%" />
        <textarea id="goal-desc-input" placeholder="Describe the goal ‚Äî why it matters, what done looks like" style="min-height:60px;margin-bottom:0.6rem"></textarea>
        <div class="goal-form-grid">
          <input type="number" id="goal-target-input" placeholder="Target amount (e.g. 25000)" min="0" step="100" />
          <input type="number" id="goal-saved-input" placeholder="Current amount (e.g. 3500)" min="0" step="100" />
        </div>
        <div class="btn-row">
          <button onclick="addGoal()">Add Goal</button>
          <button class="btn-outline" onclick="askClaudeAboutGoals()" id="goals-ask-btn">Ask Claude about my goals</button>
        </div>
      </div>
      <div id="goals-claude-response" style="display:none" class="panel-box">
        <div class="panel-box-header"><span class="panel-box-title">Claude's perspective</span></div>
        <div class="panel-box-body"><div id="goals-claude-text" style="font-size:0.78rem;line-height:1.7;color:var(--text-dim);white-space:pre-wrap"></div></div>
      </div>
      <div id="goals-container"></div>
    </div>
  </div>

  <!-- RIGHT SIDEBAR -->
  <div class="sidebar-right">

    <!-- Ask Claude -->
    <div class="panel-box">
      <div class="panel-box-header"><span class="panel-box-title">Ask Claude</span></div>
      <div class="panel-box-body">
        <textarea id="ask-input" placeholder="What should I focus on today?" style="min-height:60px;margin-bottom:0.6rem"></textarea>
        <button onclick="askClaude()" id="ask-btn" style="width:100%">Ask</button>
        <div id="claude-response" style="font-size:0.78rem;line-height:1.7;color:var(--text-dim);white-space:pre-wrap;margin-top:0.85rem">Claude's answer will appear here.</div>
      </div>
    </div>

    <!--
      PHASE 3 NEW ‚Äî Notification Log
      Shows what proactive notifications Claude has sent,
      so you can see the agentic behavior in action.
    -->
    <div class="panel-box">
      <div class="panel-box-header">
        <span class="panel-box-title">Notifications Sent</span>
        <button class="btn-outline" style="font-size:0.65rem;padding:0.2rem 0.5rem" onclick="loadNotificationLog()">Refresh</button>
      </div>
      <div class="panel-box-body">
        <div id="notif-log"><span class="notif-empty">No notifications sent yet.</span></div>
        <div class="phase-note" style="margin-top:0.75rem">
          <strong>Phase 3:</strong> Claude runs on your server on a schedule.
          This log shows when it decided to proactively reach out to you.
        </div>
      </div>
    </div>

    <!-- Test triggers -->
    <div class="panel-box">
      <div class="panel-box-header"><span class="panel-box-title">Test Notifications</span></div>
      <div class="panel-box-body">
        <p style="font-size:0.73rem;color:var(--text-muted);margin-bottom:0.75rem;line-height:1.5">
          Trigger a notification now to test your setup ‚Äî don't wait for the schedule.
        </p>
        <button onclick="triggerMorningBriefing()" id="trigger-btn" style="width:100%">Send Morning Briefing Now</button>
        <div id="trigger-result" style="font-size:0.72rem;color:var(--text-muted);margin-top:0.5rem"></div>
      </div>
    </div>

    <!-- About Me / Memory -->
    <div class="panel-box">
      <div class="panel-box-header">
        <span class="panel-box-title">About Me (Claude's Memory)</span>
        <button class="btn-outline" style="font-size:0.65rem;padding:0.2rem 0.5rem" onclick="saveMemory()">Save</button>
      </div>
      <div class="panel-box-body">
        <textarea id="memory-text" placeholder="Tell Claude about yourself ‚Äî role, priorities, work style‚Ä¶" style="min-height:80px"></textarea>
      </div>
    </div>

  </div>
</div>

<!-- MOBILE BOTTOM NAV -->
<nav class="mobile-nav">
  <button class="mobile-nav-btn active" id="mnav-tasks" onclick="mobileTab('tasks')">
    <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
    Tasks
  </button>
  <button class="mobile-nav-btn" id="mnav-goals" onclick="mobileTab('goals')">
    <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
    Goals
  </button>
  <button class="mobile-nav-btn" id="mnav-ask" onclick="openDrawer('ask')">
    <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
    Ask Claude
  </button>
  <button class="mobile-nav-btn" id="mnav-more" onclick="openDrawer('more')">
    <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
    More
  </button>
</nav>

<!-- DRAWER OVERLAY -->
<div class="mobile-drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>

<!-- ASK CLAUDE DRAWER -->
<div class="mobile-drawer" id="drawer-ask">
  <div class="drawer-handle"></div>
  <div class="drawer-title">Ask Claude</div>
  <textarea id="ask-input-mobile" placeholder="What should I focus on today? What's urgent?" style="min-height:80px;margin-bottom:0.75rem"></textarea>
  <button onclick="askClaudeMobile()" id="ask-btn-mobile" style="width:100%;margin-bottom:0.85rem">Ask</button>
  <div id="claude-response-mobile" style="font-size:0.82rem;line-height:1.7;color:var(--text-dim);white-space:pre-wrap">Claude's answer will appear here.</div>
</div>

<!-- MORE DRAWER -->
<div class="mobile-drawer" id="drawer-more">
  <div class="drawer-handle"></div>
  <div class="drawer-title">Notifications Sent</div>
  <div id="notif-log-mobile" style="margin-bottom:1.25rem"><span style="font-size:0.74rem;color:var(--text-muted);font-style:italic">No notifications yet.</span></div>
  <div class="drawer-title">Test</div>
  <button onclick="triggerMorningBriefing()" style="width:100%;margin-bottom:0.5rem">Send Morning Briefing Now</button>
  <div id="trigger-result-mobile" style="font-size:0.72rem;color:var(--text-muted)"></div>
  <br/>
  <div class="drawer-title" style="margin-top:0.75rem">About Me (Claude's Memory)</div>
  <textarea id="memory-text-mobile" placeholder="Tell Claude about yourself‚Ä¶" style="min-height:80px;margin-bottom:0.6rem"></textarea>
  <button class="btn-outline" style="width:100%" onclick="saveMemoryMobile()">Save Memory</button>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PHASE 3 FRONTEND
//
//  KEY CHANGES vs Phase 2:
//  1. All data syncs to/from the server (no more localStorage for tasks)
//  2. Claude calls go through the server (API key never in browser)
//  3. Notification log shows what Claude has done autonomously
//  4. Manual trigger lets you test the scheduler immediately
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Stored in localStorage ‚Äî just connection config, not your data
const CONFIG_KEYS = {
  serverUrl: 'p3_server_url',
  secret:    'p3_secret',
  memory:    'p3_memory'
};

let serverUrl = '';
let secret    = '';
let tasks     = [];
let goals     = [];
let memory    = '';
let activeFilter = 'all';
let activeTab    = 'tasks';

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  serverUrl = localStorage.getItem(CONFIG_KEYS.serverUrl) || '';
  secret    = localStorage.getItem(CONFIG_KEYS.secret)    || '';
  memory    = localStorage.getItem(CONFIG_KEYS.memory)    || '';

  if (memory) document.getElementById('memory-text').value = memory;

  if (serverUrl && secret) {
    document.getElementById('setup-modal').style.display = 'none';
    await syncNow();
    await loadNotificationLog();
  }
}

// ‚îÄ‚îÄ SERVER CONNECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function connectServer() {
  const url    = document.getElementById('server-url-input').value.trim().replace(/\/$/, '');
  const sec    = document.getElementById('server-secret-input').value.trim();
  const errEl  = document.getElementById('modal-error');

  if (!url || !sec) {
    errEl.textContent = 'Please enter both the server URL and secret.';
    errEl.style.display = 'block';
    return;
  }

  setSyncStatus('syncing', 'Connecting...');
  try {
    const res = await fetch(`${url}/health`);
    if (!res.ok) throw new Error('Server returned ' + res.status);
    await res.json();

    serverUrl = url;
    secret    = sec;
    localStorage.setItem(CONFIG_KEYS.serverUrl, serverUrl);
    localStorage.setItem(CONFIG_KEYS.secret, secret);

    document.getElementById('setup-modal').style.display = 'none';
    await syncNow();
    await loadNotificationLog();
  } catch (err) {
    errEl.textContent = `Could not connect: ${err.message}`;
    errEl.style.display = 'block';
    setSyncStatus('error', 'Connection failed');
  }
}

// ‚îÄ‚îÄ SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
/*
  LEARNING NOTE ‚Äî Bidirectional sync

  On load: pull tasks + goals from server (server is source of truth)
  On change: push updated tasks/goals to server immediately

  This is simpler than a real sync (no conflict resolution),
  but works perfectly for a single-user personal assistant.
*/
async function syncNow() {
  if (!serverUrl || !secret) return;
  setSyncStatus('syncing', 'Syncing...');
  try {
    const [tasksRes, goalsRes, memRes] = await Promise.all([
      apiFetch('GET', '/api/tasks'),
      apiFetch('GET', '/api/goals'),
      apiFetch('GET', '/api/memory')
    ]);
    tasks  = tasksRes;
    goals  = goalsRes;
    memory = memRes.memory || '';
    if (memory) document.getElementById('memory-text').value = memory;
    renderTasks();
    renderGoals();
    setSyncStatus('ok', 'Synced');
  } catch (err) {
    setSyncStatus('error', 'Sync failed');
    console.error('Sync error:', err);
  }
}

async function pushTasks() {
  if (!serverUrl) return;
  await apiFetch('POST', '/api/tasks', { tasks });
}

async function pushGoals() {
  if (!serverUrl) return;
  await apiFetch('POST', '/api/goals', { goals });
}

// ‚îÄ‚îÄ API HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiFetch(method, path, body) {
  const opts = {
    method,
    headers: {
      'Content-Type': 'application/json',
      'x-api-secret': secret
    }
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(serverUrl + path, opts);
  if (!res.ok) throw new Error(`${path} returned ${res.status}`);
  return res.json();
}

// ‚îÄ‚îÄ CLAUDE (via server) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
/*
  LEARNING NOTE ‚Äî Server-proxied Claude calls

  In Phase 2, the browser called Claude directly.
  Now it calls /api/claude on YOUR server, which calls Claude.
  Your Anthropic API key is never in the browser.
*/
async function callClaude(systemPrompt, userMessage) {
  const data = await apiFetch('POST', '/api/claude', { systemPrompt, userMessage });
  return data.response;
}

// ‚îÄ‚îÄ SYNC STATUS UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSyncStatus(state, label) {
  document.getElementById('sync-dot').className = 'sync-dot ' + state;
  document.getElementById('sync-label').textContent = label;
}

// ‚îÄ‚îÄ SAVE MEMORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveMemory() {
  memory = document.getElementById('memory-text').value.trim();
  localStorage.setItem(CONFIG_KEYS.memory, memory);
  if (serverUrl) await apiFetch('POST', '/api/memory', { memory });
  const btn = event.target;
  btn.textContent = 'Saved ‚úì';
  setTimeout(() => btn.textContent = 'Save', 1500);
}

// ‚îÄ‚îÄ NOTIFICATION LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadNotificationLog() {
  if (!serverUrl) return;
  try {
    const log = await apiFetch('GET', '/api/notifications');
    const el = document.getElementById('notif-log');
    if (!log || log.length === 0) {
      el.innerHTML = '<span class="notif-empty">No notifications sent yet.</span>';
      return;
    }
    el.innerHTML = [...log].reverse().map(n => `
      <div class="notif-item">
        <div>${escHtml(n.type)}</div>
        <div class="notif-time">${new Date(n.sentAt).toLocaleString()}</div>
      </div>`).join('');
  } catch(e) {
    console.error('Failed to load notification log', e);
  }
}

// ‚îÄ‚îÄ TEST TRIGGER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function triggerMorningBriefing() {
  if (!serverUrl) { alert('Connect to server first.'); return; }
  const btn = document.getElementById('trigger-btn');
  btn.disabled = true;
  btn.textContent = 'Sending...';
  try {
    await pushTasks();
    const res = await apiFetch('POST', '/api/trigger/morning');
    const msg = res.message || 'Triggered.';
    document.getElementById('trigger-result').textContent = msg;
    // Sync result to mobile drawer if it exists
    const mobileResult = document.getElementById('trigger-result-mobile');
    if (mobileResult) mobileResult.textContent = msg;
    setTimeout(loadNotificationLog, 5000);
  } catch(e) {
    const msg = 'Error: ' + e.message;
    document.getElementById('trigger-result').textContent = msg;
    const mobileResult = document.getElementById('trigger-result-mobile');
    if (mobileResult) mobileResult.textContent = msg;
  }
  btn.disabled = false;
  btn.textContent = 'Send Morning Briefing Now';
}

// ‚îÄ‚îÄ ADD TASKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addTasks() {
  const input = document.getElementById('task-input').value.trim();
  if (!input) return;
  const btn = document.getElementById('add-btn');
  btn.disabled = true; btn.textContent = 'Thinking...';
  const dueDateInput = document.getElementById('due-date-input').value;

  const systemPrompt = `You are a personal task organizer. Return ONLY a JSON array ‚Äî no explanation, no markdown, no backticks.
Each item: {"title": string, "priority": "high"|"medium"|"low", "category": string, "reason": string, "dueDate": string|null}
For dueDate: if text mentions a deadline extract as YYYY-MM-DD relative to ${new Date().toISOString().slice(0,10)}, else null.`;

  try {
    const raw = await callClaude(systemPrompt, `Organize these tasks:\n${input}`);
    const parsed = JSON.parse(raw);
    parsed.forEach(t => tasks.push({
      id: Date.now() + Math.random(),
      title: t.title, priority: t.priority, category: t.category,
      reason: t.reason, dueDate: dueDateInput || t.dueDate || null,
      done: false, createdAt: new Date().toISOString()
    }));
    await pushTasks();
    document.getElementById('task-input').value = '';
    document.getElementById('due-date-input').value = '';
    renderTasks();
    setSyncStatus('ok', 'Synced');
  } catch(e) {
    alert('Error: ' + e.message);
  }
  btn.disabled = false; btn.textContent = 'Organize with Claude';
}

function addManual() {
  const input = document.getElementById('task-input').value.trim();
  const due = document.getElementById('due-date-input').value || null;
  if (!input) return;
  input.split('\n').forEach(line => {
    if (line.trim()) tasks.push({ id: Date.now()+Math.random(), title: line.trim(), priority: 'medium', category: 'General', reason: '', dueDate: due, done: false, createdAt: new Date().toISOString() });
  });
  document.getElementById('task-input').value = '';
  document.getElementById('due-date-input').value = '';
  pushTasks();
  renderTasks();
}

// ‚îÄ‚îÄ ASK CLAUDE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function askClaude() {
  const question = document.getElementById('ask-input').value.trim();
  if (!question) return;
  const btn = document.getElementById('ask-btn');
  btn.disabled = true; btn.textContent = 'Thinking...';
  document.getElementById('claude-response').textContent = '...';

  const taskContext = tasks.length
    ? tasks.map((t,i) => `${i+1}. [${t.priority.toUpperCase()}] ${t.title} (${t.category})${t.dueDate?` ‚Äî due ${t.dueDate}`:''}${t.done?' ‚úì DONE':''}`).join('\n')
    : 'No tasks yet.';
  const goalsContext = goals.filter(g=>!g.achieved).map(g=>g.title).join(', ');

  const systemPrompt = `You are a helpful personal assistant. Be concise and direct.
Today is ${new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}.`;

  try {
    const response = await callClaude(systemPrompt,
      `My tasks:\n${taskContext}${goalsContext?'\n\nLong-term goals: '+goalsContext:''}\n\nQuestion: ${question}`);
    document.getElementById('claude-response').textContent = response;
  } catch(e) {
    document.getElementById('claude-response').textContent = 'Error: ' + e.message;
  }
  btn.disabled = false; btn.textContent = 'Ask';
}

// ‚îÄ‚îÄ TASK CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTask(id) {
  const t = tasks.find(t=>t.id===id);
  if (t) { t.done=!t.done; pushTasks(); renderTasks(); }
}
function setDueDate(id, value) {
  const t = tasks.find(t=>t.id===id);
  if (t) { t.dueDate=value||null; pushTasks(); renderTasks(); }
}
function deleteTask(id) {
  tasks = tasks.filter(t=>t.id!==id);
  pushTasks(); renderTasks();
}
function clearDone() { tasks=tasks.filter(t=>!t.done); pushTasks(); renderTasks(); }
function resetAll() {
  if (!confirm('Delete all tasks?')) return;
  tasks=[]; pushTasks(); renderTasks();
}

// ‚îÄ‚îÄ GOALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addGoal() {
  const title = document.getElementById('goal-title-input').value.trim();
  if (!title) return;
  goals.push({
    id: Date.now()+Math.random(), title,
    description: document.getElementById('goal-desc-input').value.trim(),
    target: parseFloat(document.getElementById('goal-target-input').value)||null,
    saved: parseFloat(document.getElementById('goal-saved-input').value)||0,
    note: '', achieved: false, createdAt: new Date().toISOString()
  });
  pushGoals(); renderGoals();
  ['goal-title-input','goal-desc-input','goal-target-input','goal-saved-input'].forEach(id=>document.getElementById(id).value='');
}
function updateGoalProgress(id, field, value) {
  const g = goals.find(g=>g.id===id);
  if (!g) return;
  if (field === 'note') {
    g[field] = value;
  } else {
    const num = parseFloat(value);
    g[field] = isNaN(num) ? null : num;
  }
  pushGoals();
  if (field !== 'note') renderGoals();
}
function saveGoalNote(id) {
  const el = document.getElementById('goal-note-'+id);
  if (el) updateGoalProgress(id,'note',el.value);
  renderGoals();
}
function toggleGoalAchieved(id) {
  const g = goals.find(g=>g.id===id);
  if (g) { g.achieved=!g.achieved; pushGoals(); renderGoals(); }
}
function deleteGoal(id) {
  if (!confirm('Remove this goal?')) return;
  goals=goals.filter(g=>g.id!==id); pushGoals(); renderGoals();
}
async function askClaudeAboutGoals() {
  const btn = document.getElementById('goals-ask-btn');
  btn.disabled=true; btn.textContent='Thinking...';
  const goalCtx = goals.filter(g=>!g.achieved).map(g=>`- ${g.title}${g.target?` (${Math.round(g.saved/g.target*100)}% funded)`:''}`).join('\n')||'None';
  const taskCtx = tasks.filter(t=>!t.done).slice(0,8).map(t=>`- [${t.priority}] ${t.title}`).join('\n')||'None';
  const systemPrompt = `You are a thoughtful personal coach. Be warm and concise ‚Äî 3-5 sentences. Today is ${new Date().toLocaleDateString()}.`;
  try {
    const response = await callClaude(systemPrompt, `Goals:\n${goalCtx}\n\nOpen tasks:\n${taskCtx}\n\nAm I keeping sight of my big goals? Any connections or nudges?`);
    document.getElementById('goals-claude-response').style.display='block';
    document.getElementById('goals-claude-text').textContent=response;
  } catch(e) { alert('Error: '+e.message); }
  btn.disabled=false; btn.textContent='Ask Claude about my goals';
}

// ‚îÄ‚îÄ FILTERING & TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  document.getElementById('view-tasks').style.display = tab==='tasks'?'':'none';
  document.getElementById('view-goals').style.display = tab==='goals'?'':'none';
  document.getElementById('tab-tasks').className = 'tab-btn'+(tab==='tasks'?' active':'');
  document.getElementById('tab-goals').className = 'tab-btn'+(tab==='goals'?' active':'');
}
function setFilter(f) {
  activeFilter=f;
  document.querySelectorAll('.stat-item,.cat-item').forEach(el=>el.classList.remove('active'));
  const el = document.getElementById('filter-'+f);
  if (el) el.classList.add('active');
  renderTasks();
}
function getFilteredTasks() {
  switch(activeFilter) {
    case 'open':   return tasks.filter(t=>!t.done);
    case 'done':   return tasks.filter(t=>t.done);
    case 'high':   return tasks.filter(t=>t.priority==='high');
    case 'medium': return tasks.filter(t=>t.priority==='medium');
    case 'low':    return tasks.filter(t=>t.priority==='low');
    case 'due-soon': {
      const today=new Date(); today.setHours(0,0,0,0);
      const three=new Date(today); three.setDate(today.getDate()+3);
      return tasks.filter(t=>!t.done&&t.dueDate&&new Date(t.dueDate+'T00:00:00')<=three);
    }
    default:
      if (activeFilter.startsWith('cat:')) return tasks.filter(t=>t.category===activeFilter.slice(4));
      return tasks;
  }
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTasks() {
  const container = document.getElementById('task-container');
  const filtered  = getFilteredTasks();
  const today=new Date(); today.setHours(0,0,0,0);
  const three=new Date(today); three.setDate(today.getDate()+3);

  document.getElementById('count-all').textContent    = tasks.length;
  document.getElementById('count-open').textContent   = tasks.filter(t=>!t.done).length;
  document.getElementById('count-done').textContent   = tasks.filter(t=>t.done).length;
  document.getElementById('count-due-soon').textContent = tasks.filter(t=>!t.done&&t.dueDate&&new Date(t.dueDate+'T00:00:00')<=three).length;
  document.getElementById('count-high').textContent   = tasks.filter(t=>t.priority==='high').length;
  document.getElementById('count-medium').textContent = tasks.filter(t=>t.priority==='medium').length;
  document.getElementById('count-low').textContent    = tasks.filter(t=>t.priority==='low').length;

  const cats = [...new Set(tasks.map(t=>t.category))].sort();
  document.getElementById('cat-list').innerHTML = cats.map(c=>`
    <div class="cat-item ${activeFilter==='cat:'+c?'active':''}"
      onclick="setFilter('cat:${c}');document.querySelectorAll('.cat-item').forEach(e=>e.classList.remove('active'));this.classList.add('active')">
      <div class="cat-dot"></div>${escHtml(c)}
    </div>`).join('');

  if (filtered.length===0) {
    container.innerHTML=`<div class="empty-state"><span class="big">All clear</span>${tasks.length===0?'Add your first task above.':'No tasks match this filter.'}</div>`;
    return;
  }
  const open = filtered.filter(t=>!t.done).sort((a,b)=>({high:0,medium:1,low:2}[a.priority]-{high:0,medium:1,low:2}[b.priority]));
  const done = filtered.filter(t=>t.done);
  let html='';
  if (open.length) { html+=`<div class="task-group-label">Open ¬∑ ${open.length}</div>`; html+=open.map(renderTask).join(''); }
  if (done.length) { html+=`<div class="task-group-label" style="margin-top:1.5rem">Completed ¬∑ ${done.length}</div>`; html+=done.map(renderTask).join(''); }
  container.innerHTML=html;
}

function dueDateStatus(dateStr) {
  if (!dateStr) return null;
  const due=new Date(dateStr+'T00:00:00');
  const today=new Date(); today.setHours(0,0,0,0);
  const diff=Math.round((due-today)/(1000*60*60*24));
  if (diff<0)  return {label:`Overdue by ${Math.abs(diff)}d`,cls:'overdue'};
  if (diff===0) return {label:'Due today',cls:'due-soon'};
  if (diff<=3)  return {label:`Due in ${diff}d`,cls:'due-soon'};
  return {label:due.toLocaleDateString('en-US',{month:'short',day:'numeric'}),cls:'on-track'};
}

function renderTask(t) {
  const due=dueDateStatus(t.dueDate);
  const dueBadge=due
    ?`<span class="due-date ${due.cls}" onclick="document.getElementById('de-${t.id}').showPicker()">üìÖ ${due.label}</span>
       <input type="date" id="de-${t.id}" value="${t.dueDate||''}" onchange="setDueDate(${t.id},this.value)" style="position:absolute;opacity:0;pointer-events:none;width:0;height:0">`
    :`<span class="due-date" onclick="document.getElementById('de-${t.id}').showPicker()">+ due date</span>
       <input type="date" id="de-${t.id}" value="" onchange="setDueDate(${t.id},this.value)" style="position:absolute;opacity:0;pointer-events:none;width:0;height:0">`;
  return `
    <div class="task-card priority-${t.priority} ${t.done?'done':''}" style="position:relative">
      <div class="task-check" onclick="toggleTask(${t.id})">
        <svg width="9" height="7" viewBox="0 0 9 7" fill="none"><path d="M1 3.5L3 5.5L8 1" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="task-body">
        <div class="task-title">${escHtml(t.title)}</div>
        <div class="task-meta">
          <span class="badge badge-${t.priority}">${t.priority}</span>
          <span class="badge badge-cat">${escHtml(t.category)}</span>
          ${dueBadge}
        </div>
        ${t.reason?`<div class="task-reason">${escHtml(t.reason)}</div>`:''}
      </div>
      <div class="task-actions">
        <button class="task-action-btn del" onclick="deleteTask(${t.id})">delete</button>
      </div>
    </div>`;
}

function renderGoals() {
  const container = document.getElementById('goals-container');
  if (!container) return;
  const open = goals.filter(g=>!g.achieved).length;
  document.getElementById('tab-goals').textContent = open ? `Goals (${open})` : 'Goals';
  if (goals.length===0) { container.innerHTML=`<div class="empty-state"><span class="big">Dream big</span>Add your first long-term goal above.</div>`; return; }
  const active=goals.filter(g=>!g.achieved), achieved=goals.filter(g=>g.achieved);
  let html='';
  if (active.length) { html+=`<div class="task-group-label">In Progress ¬∑ ${active.length}</div>`; html+=active.map(renderGoalCard).join(''); }
  if (achieved.length) { html+=`<div class="task-group-label" style="margin-top:1.5rem">Achieved ¬∑ ${achieved.length}</div>`; html+=achieved.map(renderGoalCard).join(''); }
  container.innerHTML=html;
}

function renderGoalCard(g) {
  const pct = g.target ? Math.min(100, Math.round(g.saved / g.target * 100)) : null;

  // Progress bar (only when target is set)
  const barHtml = g.target ? `
    <div class="goal-progress-row">
      <div class="goal-progress-bar"><div class="goal-progress-fill" style="width:${pct}%"></div></div>
      <span class="goal-progress-pct">${pct}%</span>
    </div>
    <div class="goal-meta"><span class="goal-amount">
      <strong>$${g.saved.toLocaleString()}</strong> saved of
      <strong>$${g.target.toLocaleString()}</strong> &nbsp;¬∑&nbsp;
      $${Math.max(0, g.target - g.saved).toLocaleString()} to go
    </span></div>` : '';

  // Always-visible editable amount fields
  const numStyle = `background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:0.78rem;padding:0.35rem 0.6rem;outline:none;min-height:unset;width:100%;transition:border-color 0.2s`;
  const amountsHtml = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-top:0.65rem;margin-bottom:0.25rem">
      <div>
        <div style="font-size:0.62rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.25rem">Target ($)</div>
        <input type="number" value="${g.target || ''}" min="0" step="100" placeholder="Set target‚Ä¶"
          style="${numStyle}"
          onchange="updateGoalProgress(${g.id},'target',this.value)"
          onfocus="this.style.borderColor='var(--accent2)'"
          onblur="this.style.borderColor='var(--border)'" />
      </div>
      <div>
        <div style="font-size:0.62rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.25rem">Saved so far ($)</div>
        <input type="number" value="${g.saved || ''}" min="0" step="100" placeholder="0"
          style="${numStyle}"
          onchange="updateGoalProgress(${g.id},'saved',this.value)"
          onfocus="this.style.borderColor='var(--accent2)'"
          onblur="this.style.borderColor='var(--border)'" />
      </div>
    </div>`;

  return `
    <div class="goal-card ${g.achieved ? 'goal-achieved' : ''}">
      <div class="goal-header">
        <div class="goal-title">${escHtml(g.title)}</div>
        <div class="goal-actions">
          <button class="task-action-btn" onclick="toggleGoalAchieved(${g.id})">${g.achieved ? 'Reopen' : '‚úì Done'}</button>
          <button class="task-action-btn del" onclick="deleteGoal(${g.id})">delete</button>
        </div>
      </div>
      ${g.description ? `<div class="goal-desc">${escHtml(g.description)}</div>` : ''}
      ${barHtml}
      ${amountsHtml}
      <div style="border-top:1px solid var(--border);margin-top:0.6rem;padding-top:0.6rem">
        <div class="goal-note" onclick="this.style.display='none';document.getElementById('gn-${g.id}').style.display='block';document.getElementById('gn-${g.id}').focus()">
          ${escHtml(g.note) || '<em>Add a progress note‚Ä¶</em>'}
        </div>
        <textarea id="gn-${g.id}" class="goal-note-input" style="display:none" onblur="saveGoalNote(${g.id})"
          placeholder="Add a progress note‚Ä¶">${escHtml(g.note)}</textarea>
      </div>
    </div>`;
}

function escHtml(str) { return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ‚îÄ‚îÄ MOBILE NAV & DRAWERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mobileTab(tab) {
  switchTab(tab);
  document.querySelectorAll('.mobile-nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('mnav-' + tab).classList.add('active');
}

function openDrawer(name) {
  closeDrawer();
  document.getElementById('drawer-overlay').classList.add('open');
  document.getElementById('drawer-' + name).classList.add('open');
  document.querySelectorAll('.mobile-nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('mnav-' + name).classList.add('active');

  // Sync memory textarea in drawer
  if (name === 'more') {
    const memMain = document.getElementById('memory-text');
    if (memMain) document.getElementById('memory-text-mobile').value = memMain.value;
    syncNotifLogMobile();
  }
}

function closeDrawer() {
  document.getElementById('drawer-overlay').classList.remove('open');
  document.querySelectorAll('.mobile-drawer').forEach(d => d.classList.remove('open'));
  document.querySelectorAll('.mobile-nav-btn').forEach(b => b.classList.remove('active'));
  // Re-highlight the current tab
  const tab = activeTab || 'tasks';
  const btn = document.getElementById('mnav-' + tab);
  if (btn) btn.classList.add('active');
}

// Ask Claude from mobile drawer ‚Äî mirrors desktop askClaude()
async function askClaudeMobile() {
  const question = document.getElementById('ask-input-mobile').value.trim();
  if (!question) return;
  const btn = document.getElementById('ask-btn-mobile');
  btn.disabled = true; btn.textContent = 'Thinking...';
  document.getElementById('claude-response-mobile').textContent = '...';

  const taskContext = tasks.length
    ? tasks.map((t,i) => `${i+1}. [${t.priority.toUpperCase()}] ${t.title}${t.dueDate?' ‚Äî due '+t.dueDate:''}${t.done?' ‚úì DONE':''}`).join('\n')
    : 'No tasks yet.';
  const goalsContext = goals.filter(g=>!g.achieved).map(g=>g.title).join(', ');
  const systemPrompt = `You are a helpful personal assistant. Be concise and direct. Today is ${new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}.`;

  try {
    const response = await callClaude(systemPrompt,
      `My tasks:\n${taskContext}${goalsContext?'\n\nLong-term goals: '+goalsContext:''}\n\nQuestion: ${question}`);
    document.getElementById('claude-response-mobile').textContent = response;
    // Also sync to desktop panel
    document.getElementById('claude-response').textContent = response;
  } catch(e) {
    document.getElementById('claude-response-mobile').textContent = 'Error: ' + e.message;
  }
  btn.disabled = false; btn.textContent = 'Ask';
}

function saveMemoryMobile() {
  const val = document.getElementById('memory-text-mobile').value;
  document.getElementById('memory-text').value = val;
  // Trigger save via desktop function
  const fakeEvent = { target: { textContent: 'Save' } };
  memory = val;
  localStorage.setItem('p3_memory', memory);
  if (serverUrl) apiFetch('POST', '/api/memory', { memory });
  document.getElementById('memory-text-mobile').style.borderColor = 'var(--accent2)';
  setTimeout(() => document.getElementById('memory-text-mobile').style.borderColor = '', 1500);
}

function syncNotifLogMobile() {
  const desktop = document.getElementById('notif-log');
  const mobile  = document.getElementById('notif-log-mobile');
  if (desktop && mobile) mobile.innerHTML = desktop.innerHTML;
}


document.addEventListener('keydown', e => {
  if ((e.metaKey||e.ctrlKey) && e.key==='Enter') {
    if (document.activeElement===document.getElementById('task-input')) addTasks();
    if (document.activeElement===document.getElementById('ask-input'))  askClaude();
  }
});

init();
</script>
</body>
</html>
